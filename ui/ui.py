import streamlit as st
from PIL import Image
from groq import Groq
import openai
import os
from dotenv import load_dotenv
from openai import OpenAI
import base64
from huggingface_hub import InferenceClient


# === Set Layout of Streamlit ===
st.set_page_config(page_title="‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß", page_icon="üåç", layout="wide")

# === Load API Keys ===
load_dotenv()
groq_client = Groq(api_key=os.getenv("GROQ_API_KEY"))
openai_api_key = os.getenv("OPENAI_API_KEY")

# ‡∏û‡∏≤‡∏ò‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
background_image_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), "‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß.png")

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û‡πÄ‡∏õ‡πá‡∏ô Base64
def get_base64_of_bin_file(bin_file):
    with open(bin_file, 'rb') as f:
        data = f.read()
    return base64.b64encode(data).decode()

# ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
if os.path.exists(background_image_path):
    # ‡πÅ‡∏õ‡∏•‡∏á‡∏†‡∏≤‡∏û‡πÄ‡∏õ‡πá‡∏ô Base64
    base64_image = get_base64_of_bin_file(background_image_path)
    
    # ‡πÉ‡∏™‡πà CSS ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
    st.markdown(
        f"""
        <style>
        .stApp {{
            background-image: url("data:image/png;base64,{base64_image}");
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            font-family: 'Arial', sans-serif;
            color: #333;
        }}
        </style>
        """,
        unsafe_allow_html=True,
    )
else:
    st.error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå!")
st.markdown(
    f"""
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
    .stApp {{
        background-size: cover;
        background-attachment: fixed;
        background-position: center;
        font-family: 'Arial', sans-serif;
        color: #333;
    }}
    .spacing {{
        margin-top: 70px;
    }}
    .distance {{
        margin-top: 15px;
        margin-bottom: 0px;
        padding-bottom: 0px;
    }}
    .header {{
        text-align: center;
        margin-bottom: 30px;
        color: white;
    }}
    .result-box {{
        border: 2px solid #ddd;
        padding: 20px;
        border-radius: 12px;
        background-color: white;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease-in-out;
    }}
    .result-box:hover {{
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }}
    </style>
    """,
    unsafe_allow_html=True,
)

# === Header ===
st.markdown("<h1 class='header' style='color: white;'>‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</h1>", unsafe_allow_html=True)

# === Input Form ===
with st.container():  # ‡πÉ‡∏ä‡πâ container ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
    st.markdown('<div class="form-container">',unsafe_allow_html=True)

    col1, col2, col3, col4, col5 = st.columns([2, 2, 2, 2, 1.5])

    with col1:
        st.markdown("<div class='distance' style='color: white;'><i class='bi bi-geo-alt'></i> Where to?</div>", unsafe_allow_html=True)
        province = st.selectbox("", ["‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô", "‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°", "‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä", "‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå", "‡πÄ‡∏•‡∏¢"])

    with col2:
        st.markdown("<div class='distance' style='color: white;'><i class='bi bi-calendar'></i> Days </div>", unsafe_allow_html=True)
        days = st.number_input("", min_value=1, step=1, value=3, format="%d")

    with col3:
        st.markdown("<div class='distance' style='color: white;'><i class='bi bi-compass'></i> Types</div></div>",unsafe_allow_html=True,)
        activity_type = st.multiselect("", ["‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥", "‡πÄ‡∏°‡∏∑‡∏≠‡∏á", "‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°", "‡πÄ‡∏≠‡∏Å‡∏ã‡πå‡∏ï‡∏£‡∏µ‡∏°", "‡∏ä‡∏¥‡∏• ‡πÜ ‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà"])

    with col4:
        st.markdown("<div class='distance' style='color: white;'><i class='bi bi-cash'></i> Price</div>", unsafe_allow_html=True)
        budget = st.selectbox("", ["Low to High", "Hight to Low"])
        

    with col5:
        st.markdown("<div class='spacing'></div>", unsafe_allow_html=True)
        search = st.button("Search", key="search")
    st.markdown("</div>", unsafe_allow_html=True) 

# Helper function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏õ‡πá‡∏ô Base64
def encode_image_to_base64(image_path):
    with open(image_path, "rb") as image_file:
        encoded_string = base64.b64encode(image_file.read()).decode("utf-8")
    return encoded_string
# === Helper Function: Encode Image to Base64 ===
def encode_image_to_base64(image_path):
    with open(image_path, "rb") as image_file:
        encoded_string = base64.b64encode(image_file.read()).decode("utf-8")
    return encoded_string

# === Generate Image ===
def generate_image(prompt):
    image_dir_name = "images"
    image_dir = os.path.join(os.path.dirname(os.path.abspath(__file__)), image_dir_name)
    if not os.path.isdir(image_dir):
        os.mkdir(image_dir)
    
    client = InferenceClient(
        "strangerzonehf/Flux-Midjourney-Mix2-LoRA", token="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"
    )
    image = client.text_to_image(prompt)
    image_path = os.path.join(image_dir, "generated_image.png")
    image.save(image_path)
    return image_path


# === ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö ===
if search:
    if not province or not days or not activity_type or not budget:
        st.error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤!")
    else:
        with st.spinner("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•..."):
            try:
                # === ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Groq ===
                query = f"""
                ‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡πÉ‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î {province} 
                ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô {days} ‡∏ß‡∏±‡∏ô ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì {budget} ‡∏ö‡∏≤‡∏ó 
                ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß {', '.join(activity_type)}
                """
                chat_completion = groq_client.chat.completions.create(
                    messages=[{"role": "user", "content": query}],
                    model="llama-3.1-70b-versatile",
                )
                travel_plan = chat_completion.choices[0].message.content

                # === Generate Image ===
                translated_prompt = f"Travel plan for {province} with {days} days: {travel_plan}"
                image_path = generate_image(translated_prompt)
                base64_image = encode_image_to_base64(image_path)

                # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö
                st.markdown("<h6 style = 'color: white;'>‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h6>", unsafe_allow_html=True)
                st.markdown(
                    f"""
                    <div class='result-box'>
                        <img src='data:image/png;base64,{base64_image}' alt='‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß' 
                             style='width:100%; border-radius:8px; margin-bottom:15px;'>
                        <div style='color: black;'>{travel_plan}</div>
                    </div>
                    """,
                    unsafe_allow_html=True,
                )

            except Exception as e:
                st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {e}")
